<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etymology Map of India</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        
        #dashboard {
            position: absolute; top: 20px; right: 20px; width: 360px;
            background: rgba(255, 255, 255, 0.98); padding: 0; /* Removed padding to fit tabs */
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000; display: none; max-height: 90vh; overflow-y: auto;
        }

        /* HEADER */
        .dash-header { padding: 20px 20px 10px 20px; }
        h2 { margin: 0 0 5px 0; color: #2c3e50; font-size: 22px; }
        .subtitle { color: #7f8c8d; font-size: 13px; }

        /* TABS */
        .tab-container { display: flex; border-bottom: 1px solid #eee; margin-top: 10px; }
        .tab-btn {
            flex: 1; padding: 12px; background: none; border: none;
            font-weight: 600; color: #95a5a6; cursor: pointer; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: #2c3e50; border-bottom: 3px solid #e74c3c; }
        .tab-btn:hover { background: #f9f9f9; }

        /* TAB CONTENT AREAS */
        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; }

        /* INSIGHTS TEXT STYLING */
        #insight-text { font-size: 14px; line-height: 1.6; color: #34495e; }
        #insight-text h4 { margin-top: 0; color: #e74c3c; }
        #insight-text ul { padding-left: 20px; margin-bottom: 15px; }
        #insight-text li { margin-bottom: 5px; }

        /* CONTROLS (Stats Tab) */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: bold; transition: all 0.2s;
        }
        .btn-chart { background: #ecf0f1; color: #2c3e50; }
        .btn-chart.active { background: #2c3e50; color: white; }
        .btn-dl { background: #27ae60; color: white; }
        
        #back-btn { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; cursor: pointer; font-weight: bold; }

        /* LEGEND */
        .legend-section { margin-top: 15px; }
        .legend-title { font-size: 11px; font-weight: bold; color: #95a5a6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 13px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="dashboard">
        <div class="dash-header">
            <h2 id="city-title">City</h2>
            <div class="subtitle" id="city-stats">Loading...</div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" onclick="openTab('stats')">Data & Charts</button>
            <button class="tab-btn" onclick="openTab('insights')">Insights</button>
        </div>

        <div id="view-stats" class="tab-content active">
            <div class="controls">
                <button class="btn btn-chart active" onclick="switchChart('doughnut')">Donut</button>
                <button class="btn btn-chart" onclick="switchChart('bar')">Bar</button>
                <button class="btn btn-dl" onclick="downloadCSV()">⬇ CSV</button>
            </div>
            <canvas id="mainChart" width="300" height="250"></canvas>
            <div id="legends"></div>
        </div>

        <div id="view-insights" class="tab-content">
            <div id="insight-text">
                Select a city to read insights.
            </div>
        </div>
        
        <button id="back-btn" onclick="location.reload()">Back to India Map</button>
    </div>

    <script>
        // --- 1. YOUR INSIGHTS DATABASE ---
        // EDIT THIS SECTION TO ADD TEXT FOR EACH CITY
        const cityInsights = {
            "Bengaluru, Karnataka": `
                <h4>From Pete to City</h4>
                <p>Bengaluru's place names evolved alongside its radial expansion over history. </p>
                <ul>
                    <li><b>-halli (Village):</b> This suffix dominates the map, proving that modern Bangalore was formed by absorbing hundreds of existing agrarian villages (e.g., Marathahalli, Kodihalli).</li>
                    <li><b>-nagar (City):</b> These represent the planned extensions post-Independence (e.g., Jayanagar, Indiranagar). Note how they cluster in organized grids.</li>
                    <li><b>English Influence:</b> Areas like 'Town' (Frazer Town) and 'Layout' reflect the British Cantonment era and modern real estate booms.</li>
                </ul>
                <p><i>Click the 'Data' tab to see the breakdown.</i></p>
            `,
            "Mumbai": `
                <h4>Example Text for Mumbai</h4>
                <p>When you add Mumbai data later, you can type its history here.</p>
            `
        };

        // --- 2. CONFIGURATION ---
        const colorPalette = {
             'Sanskrit': [
                '#F57F17', '#F9A825', '#FBC02D', '#FDD835', '#FFEB3B', 
                '#FFEE58', '#FFF176', '#FFF59D'
            ],
            'English': [
                '#0D47A1', '#1565C0', '#1976D2', '#1E88E5', '#2196F3', 
                '#42A5F5', '#64B5F6', '#90CAF9', '#BBDEFB', '#E3F2FD', 
                '#01579B', '#0277BD', '#0288D1', '#039BE5', '#03A9F4'
            ],
            'Dravidian': ['#4A0404','#610505','#780606’,‘#900C0C’,’#A71313’,’#BE1A1A’,’#D62323’,’#E53935’,’#EF5350’,’#E57373’,’#EF9A9A’,’#FFCDD2’,’#FFEBEE’,’#FF8A80’,’#FF5252’],
            'Other': ['#95a5a6']
        };

        let map, chartInstance;
        let currentCityData = null;
        let markers = [];
        let chartType = 'doughnut';

        // --- INIT MAP ---
        map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // --- LOAD DATA ---
        fetch('data.json')
            .then(res => res.json())
            .then(data => initIndia(data));

        function initIndia(data) {
            data.cities.forEach(city => {
                L.marker(city.coords).addTo(map)
                 .bindTooltip(`<b>${city.name}</b><br>Click to explore`)
                 .on('click', () => loadCity(city));
            });
        }

        // --- LOAD CITY ---
        function loadCity(city) {
            currentCityData = city;
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('city-title').innerText = city.name;
            document.getElementById('city-stats').innerText = `${city.neighborhoods.length} Neighborhoods`;

            // INJECT INSIGHTS
            const insightBox = document.getElementById('insight-text');
            if (cityInsights[city.name]) {
                insightBox.innerHTML = cityInsights[city.name];
            } else {
                insightBox.innerHTML = "<p>No insights added for this city yet.</p>";
            }

            // Reset to Stats Tab by default
            openTab('stats');

            map.flyTo(city.coords, city.zoom, { duration: 1.5 });
            renderMap(city.neighborhoods);
            renderChart(city.neighborhoods);
        }

        // --- TAB LOGIC ---
        function openTab(tabName) {
            // Hide all tabs
            document.getElementById('view-stats').style.display = 'none';
            document.getElementById('view-insights').style.display = 'none';
            
            // Deactivate buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(b => b.classList.remove('active'));

            // Show selected tab
            if (tabName === 'stats') {
                document.getElementById('view-stats').style.display = 'block';
                buttons[0].classList.add('active');
            } else {
                document.getElementById('view-insights').style.display = 'block';
                buttons[1].classList.add('active');
            }
        }

        // --- RENDER MAP ---
        function renderMap(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(n => {
                let color = getColor(n.l, n.s);
                let circle = L.circleMarker([n.lat, n.lon], {
                    radius: 6, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                });
                circle.suffix = n.s; 
                circle.bindPopup(`<b>${n.n}</b><br>${n.s} (${n.l})<br><i>${n.m}</i>`);
                circle.addTo(map);
                markers.push(circle);
            });
        }

        function getColor(lang, suffix) {
            let palette = colorPalette[lang] || colorPalette['Other'];
            let hash = 0;
            for (let i = 0; i < suffix.length; i++) hash += suffix.charCodeAt(i);
            return palette[hash % palette.length];
        }

        // --- CHART & STATS ---
        function renderChart(data) {
            const counts = {};
            data.forEach(n => { counts[n.s] = (counts[n.s] || 0) + 1; });
            const sortedLabels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            const values = sortedLabels.map(k => counts[k]);
            
            const bgColors = sortedLabels.map(label => {
                let item = data.find(n => n.s === label);
                return getColor(item ? item.l : 'Other', label);
            });

            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            let idx = elements[0].index;
                            let label = sortedLabels[idx];
                            filterMap(label);
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            buildLegend(counts);
        }

        function buildLegend(counts) {
            const container = document.getElementById('legends');
            container.innerHTML = '<div class="legend-section"><div class="legend-title">Top Suffixes</div></div>';
            let sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
            sorted.forEach(k => {
                container.innerHTML += `<div class="legend-item" onclick="filterMap('${k}')"><b>${k}</b>: ${counts[k]}</div>`;
            });
        }

        function filterMap(selectedSuffix) {
            markers.forEach(layer => {
                if (layer.suffix === selectedSuffix) {
                    layer.setStyle({ fillOpacity: 1, opacity: 1, radius: 8 });
                    layer.bringToFront();
                } else {
                    layer.setStyle({ fillOpacity: 0.1, opacity: 0.1, radius: 4 });
                }
            });
        }

        function switchChart(type) {
            chartType = type;
            document.querySelectorAll('.btn-chart').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (currentCityData) renderChart(currentCityData.neighborhoods);
        }

        function downloadCSV() {
            if (!currentCityData) return;
            let csvContent = "data:text/csv;charset=utf-8,Name,Suffix,Language,Meaning,Lat,Lon\n";
            currentCityData.neighborhoods.forEach(n => {
                csvContent += `"${n.n}","${n.s}","${n.l}","${n.m}",${n.lat},${n.lon}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentCityData.name}_Etymology_Data.csv`);
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
