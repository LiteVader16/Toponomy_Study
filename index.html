<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etymology Map of India</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        
        #dashboard {
            position: absolute; top: 20px; right: 20px; width: 340px;
            background: rgba(255, 255, 255, 0.95); padding: 20px;
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 1000; display: none; max-height: 90vh; overflow-y: auto;
        }
        
        h2 { margin: 0 0 5px 0; color: #2c3e50; font-size: 22px; }
        .subtitle { color: #7f8c8d; font-size: 13px; margin-bottom: 20px; }
        
        /* CONTROLS */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: bold; transition: all 0.2s;
        }
        .btn-chart { background: #ecf0f1; color: #2c3e50; }
        .btn-chart.active { background: #2c3e50; color: white; }
        .btn-dl { background: #27ae60; color: white; }
        
        #back-btn { width: 100%; padding: 10px; background: #e74c3c; color: white; margin-top: 20px; }

        /* LEGEND */
        .legend-section { margin-top: 15px; }
        .legend-title { font-size: 12px; font-weight: bold; color: #95a5a6; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 13px; cursor: pointer; padding: 2px 5px; border-radius: 4px; }
        .legend-item:hover { background: #f0f0f0; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="dashboard">
        <h2 id="city-title">City</h2>
        <div class="subtitle" id="city-stats">Loading...</div>
        
        <div class="controls">
            <button class="btn btn-chart active" onclick="switchChart('doughnut')">Donut</button>
            <button class="btn btn-chart" onclick="switchChart('bar')">Bar</button>
            <button class="btn btn-dl" onclick="downloadCSV()">â¬‡ CSV</button>
        </div>

        <canvas id="mainChart" width="300" height="250"></canvas>
        
        <div id="legends"></div>
        
        <button id="back-btn" class="btn" onclick="location.reload()">Back to India Map</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const colorPalette = {
            'Sanskrit': ['#F57F17', '#F9A825', '#FBC02D', '#FDD835', '#4caf50', '#FFEE58', '#FFF176', '#FFF59D'], // Yellows
            'Dravidian': ['#4A0404', '#610505', '#780606', '#900C0C', '#A71313', 
        '#BE1A1A', '#D62323', '#E53935', '#EF5350', '#E57373', 
        '#EF9A9A', '#FFCDD2', '#FFEBEE', '#FF8A80', '#FF5252'], // Reds
            'English': ['#0D47A1', '#1565C0', '#1976D2', '#1E88E5', '#2196F3', 
        '#42A5F5', '#64B5F6', '#90CAF9', '#BBDEFB', '#E3F2FD', 
        '#01579B', '#0277BD', '#0288D1', '#039BE5', '#03A9F4'],   // Blues
            'Other': ['#95a5a6'] // Blacks
        };

        let map, chartInstance;
        let currentCityData = null;
        let markers = [];
        let chartType = 'doughnut';

        // --- INIT MAP ---
        map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // --- LOAD DATA ---
        fetch('data.json')
            .then(res => res.json())
            .then(data => initIndia(data));

        function initIndia(data) {
            data.cities.forEach(city => {
                L.marker(city.coords).addTo(map)
                 .bindTooltip(`<b>${city.name}</b><br>Click to explore`)
                 .on('click', () => loadCity(city));
            });
        }

        // --- LOAD CITY ---
        function loadCity(city) {
            currentCityData = city; // Save for filtering
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('city-title').innerText = city.name;
            document.getElementById('city-stats').innerText = `${city.neighborhoods.length} Neighborhoods Analyzed`;

            map.flyTo(city.coords, city.zoom, { duration: 1.5 });
            renderMap(city.neighborhoods);
            renderChart(city.neighborhoods);
        }

        // --- RENDER MAP ---
        function renderMap(data) {
            // Clear old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(n => {
                let color = getColor(n.l, n.s); // Get color based on Language & Suffix
                let circle = L.circleMarker([n.lat, n.lon], {
                    radius: 5, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                });
                
                // Add Metadata for filtering
                circle.suffix = n.s; 
                
                circle.bindPopup(`<b>${n.n}</b><br>${n.s} (${n.l})<br><i>${n.m}</i>`);
                circle.addTo(map);
                markers.push(circle);
            });
        }

        // --- COLOR LOGIC ---
        function getColor(lang, suffix) {
            // Simple hash to pick a consistent color shade from the palette
            let palette = colorPalette[lang] || colorPalette['Other'];
            let hash = suffix.length % palette.length; 
            return palette[hash];
        }

        // --- CHART & STATS ---
        function renderChart(data) {
            const counts = {};
            data.forEach(n => { counts[n.s] = (counts[n.s] || 0) + 1; });

            // Sort by count
            const sortedLabels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            const values = sortedLabels.map(k => counts[k]);
            
            // Get Colors for Chart
            const bgColors = sortedLabels.map(label => {
                // Find a representative language for this suffix
                let item = data.find(n => n.s === label);
                return getColor(item ? item.l : 'Other', label);
            });

            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            let idx = elements[0].index;
                            let label = sortedLabels[idx];
                            filterMap(label);
                        }
                    },
                    plugins: { legend: { display: false } } // Hide default legend
                }
            });
            
            // Build Custom Legend (Language Grouped)
            buildLegend(counts);
        }

        function buildLegend(counts) {
            const container = document.getElementById('legends');
            container.innerHTML = "";
            // We can add grouped legends here if needed, keeping it simple for now
            // Just listing top 5 for quick reference
            let html = '<div class="legend-section"><div class="legend-title">Top Suffixes</div>';
            let sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
            
            sorted.forEach(k => {
                html += `<div class="legend-item" onclick="filterMap('${k}')">
                    <b>${k}</b>: ${counts[k]}
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // --- INTERACTION ---
        function filterMap(selectedSuffix) {
            // Toggle opacity of markers
            markers.forEach(layer => {
                if (layer.suffix === selectedSuffix) {
                    // If it matches, keep it visible (or toggle off if we build advanced logic)
                    layer.setStyle({ fillOpacity: 1, opacity: 1, radius: 8 });
                    layer.bringToFront();
                } else {
                    layer.setStyle({ fillOpacity: 0.1, opacity: 0.1, radius: 4 });
                }
            });
        }

        function switchChart(type) {
            chartType = type;
            // Update buttons
            document.querySelectorAll('.btn-chart').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            // Re-render
            if (currentCityData) renderChart(currentCityData.neighborhoods);
        }

        function downloadCSV() {
            if (!currentCityData) return;
            
            let csvContent = "data:text/csv;charset=utf-8,Name,Suffix,Language,Meaning,Lat,Lon\n";
            currentCityData.neighborhoods.forEach(n => {
                csvContent += `"${n.n}","${n.s}","${n.l}","${n.m}",${n.lat},${n.lon}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentCityData.name}_Etymology_Data.csv`);
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
