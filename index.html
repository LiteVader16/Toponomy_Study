<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etymology Map of India</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* LIGHT THEME */
            --bg-color: #f4f6f8;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border-color: #eee;
            --hover-bg: #f8f9fa;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        body.dark-mode {
            /* DARK THEME */
            --bg-color: #121212;
            --panel-bg: rgba(30, 30, 30, 0.90);
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border-color: #444;
            --hover-bg: #444;
            --shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
            overflow: hidden;
        }

        #map { height: 100vh; width: 100vw; z-index: 1; background: var(--bg-color); }
        
        #dashboard {
            position: absolute; top: 20px; right: 20px; width: 360px;
            background: var(--panel-bg); padding: 0;
            border-radius: 12px; box-shadow: var(--shadow);
            z-index: 1000; display: none; max-height: 90vh; overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .dash-header { padding: 20px 20px 10px 20px; position: relative; }
        h2 { margin: 0 0 5px 0; font-size: 22px; cursor: pointer; display: inline-block; }
        h2:hover { text-decoration: underline; color: #3498db; }
        .subtitle { color: var(--text-sub); font-size: 13px; font-weight: 600; margin-top: 4px; }

        #dm-toggle {
            position: absolute; top: 20px; right: 20px;
            background: var(--hover-bg); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 6px 10px; border-radius: 6px;
            cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        #dm-toggle:hover { transform: scale(1.05); }

        .tab-container { display: flex; border-bottom: 1px solid var(--border-color); margin-top: 10px; }
        .tab-btn {
            flex: 1; padding: 12px; background: none; border: none;
            font-weight: 600; color: var(--text-sub); cursor: pointer; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--text-main); border-bottom: 3px solid #e74c3c; }
        .tab-btn:hover { background: var(--hover-bg); }

        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; }
        #insight-text { font-size: 14px; line-height: 1.6; color: var(--text-main); }
        
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-chart { background: var(--border-color); color: var(--text-main); }
        .btn-chart.active { background: var(--text-main); color: var(--panel-bg); }
        .btn-dl { background: #27ae60; color: white; }
        #back-btn { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; cursor: pointer; font-weight: bold; }
        
        .legend-title { font-size: 11px; font-weight: bold; color: var(--text-sub); margin-bottom: 8px; text-transform: uppercase; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 13px; cursor: pointer; padding: 4px 8px; border-radius: 4px; color: var(--text-main); }
        .legend-item:hover { background: var(--hover-bg); }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        
        /* City Label Style - Below Marker */
        .city-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: #000;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }
        
        /* Dark Mode Label */
        body.dark-mode .city-label { 
            color: #fff; 
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="dashboard">
        <div class="dash-header">
            <h2 id="city-title" onclick="resetFilter()" title="Reset Map">City</h2>
            <button id="dm-toggle" onclick="toggleDarkMode()">ðŸŒ™ / â˜€</button>
            <div class="subtitle" id="city-stats">Loading...</div>
        </div>
        
        <div class="tab-container">
            <button class="tab-btn active" onclick="openTab('stats')">Data</button>
            <button class="tab-btn" onclick="openTab('insights')">Insights</button>
        </div>
        
        <div id="view-stats" class="tab-content active">
            <div class="controls">
                <button class="btn btn-chart active" onclick="switchChart('doughnut')">Donut</button>
                <button class="btn btn-chart" onclick="switchChart('bar')">Bar</button>
                <button class="btn btn-dl" onclick="downloadCSV()">â¬‡ CSV</button>
            </div>
            <canvas id="mainChart" width="300" height="250"></canvas>
            <div id="legends"></div>
        </div>
        
        <div id="view-insights" class="tab-content">
            <div id="insight-text">Select a city to view details.</div>
        </div>
        
        <button id="back-btn" onclick="location.reload()">Back to India Map</button>
    </div>

    <script>
        // CONFIG - ADD INSIGHTS HERE
        const cityInsights = {
            "Bengaluru": `<h4>Bengaluru</h4><p>Dominated by <b>-halli</b> (village) and <b>-nagar</b>.</p>`,
            "Mumbai": `<h4>Mumbai</h4><p>Characterized by <b>-wada</b> (hamlets) and <b>-baug</b>.</p>`,
            "Delhi": `<h4>Delhi</h4><p>A mix of Persian <b>-abad</b> and modern <b>-nagar</b>.</p>`,
            "Hyderabad": `<h4>Hyderabad</h4><p>Persian influence with <b>-abad</b> and Telugu <b>-pally</b>.</p>`
        };

        // ORIGINAL COLORS PRESERVED
        const colorPalette = {
             'Sanskrit': [
                '#4A0404', '#610505', '#780606', '#900C0C', '#A71313', 
                '#BE1A1A', '#D62323', '#E53935', '#EF5350', '#E57373', 
                '#EF9A9A', '#FFCDD2', '#FFEBEE', '#FF8A80', '#FF5252'
            ],
            'English': [
                '#0D47A1', '#1565C0', '#1976D2', '#1E88E5', '#2196F3', 
                '#42A5F5', '#64B5F6', '#90CAF9', '#BBDEFB', '#E3F2FD', 
                '#01579B', '#0277BD', '#0288D1', '#039BE5', '#03A9F4'
            ],
            'Dravidian': ['#1b5e20', '#2e7d32', '#388e3c', '#43a047', '#4caf50', '#66bb6a', '#81c784', '#a5d6a7'],
            'Persian': ['#4a235a', '#5b2c6f', '#6c3483', '#7d3c98', '#8e44ad', '#a569bd', '#bb8fce', '#d2b4de'],
            'Other': ['#95a5a6']
        };

        let map, chartInstance;
        let currentCityData = null;
        let markers = [];
        let chartType = 'doughnut';
        let isDarkMode = false;

        const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' });
        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' });

        map = L.map('map', { zoomControl: false, layers: [lightLayer] }).setView([20.5937, 78.9629], 5);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        fetch('data.json')
            .then(res => res.json())
            .then(data => initIndia(data))
            .catch(err => console.error(err));

        function initIndia(data) {
            data.cities.forEach(city => {
                // FIXED: Black filled circle
                let marker = L.circleMarker(city.coords, {
                    radius: 5,
                    color: 'black',
                    fillColor: 'black',
                    fillOpacity: 1,
                    weight: 1
                }).addTo(map);
                
                // FIXED: Label Strictly Below Marker
                marker.bindTooltip(city.name, {
                    permanent: true,
                    direction: 'bottom', // Points down
                    offset: [0, 5],      // Slight offset to clear the dot
                    className: 'city-label'
                }).openTooltip();
                
                marker.on('click', () => loadCity(city));
            });
        }

        function loadCity(city) {
            currentCityData = city;
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('city-title').innerText = city.name;
            document.getElementById('city-stats').innerText = `${city.neighborhoods.length} Neighborhoods`;
            
            document.getElementById('insight-text').innerHTML = cityInsights[city.name] || "<p>Insights coming soon.</p>";
            openTab('stats');
            map.flyTo(city.coords, city.zoom, { duration: 1.5 });
            resetFilter();
        }

        function renderMap(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            data.forEach(n => {
                let color = getColor(n.l, n.s);
                let circle = L.circleMarker([n.lat, n.lon], {
                    radius: 6, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                });
                circle.suffix = n.s; 
                circle.bindPopup(`<b>${n.n}</b><br>${n.s} (${n.l})<br><i>${n.m}</i>`);
                circle.addTo(map);
                markers.push(circle);
            });
        }

        function getColor(lang, suffix) {
            let keys = Object.keys(colorPalette);
            let palette = colorPalette['Other'];
            if (lang.includes('Dravidian') || lang.includes('Tamil') || lang.includes('Kannada') || lang.includes('Telugu') || lang.includes('Malayalam')) palette = colorPalette['Dravidian'];
            else if (lang.includes('English')) palette = colorPalette['English'];
            else if (lang.includes('Sanskrit') || lang.includes('Hindi') || lang.includes('Marathi') || lang.includes('Gujarati')) palette = colorPalette['Sanskrit'];
            else if (lang.includes('Persian') || lang.includes('Urdu')) palette = colorPalette['Persian'];
            let hash = 0;
            for (let i = 0; i < suffix.length; i++) hash += suffix.charCodeAt(i);
            return palette[hash % palette.length];
        }

        function renderChart(data) {
            const counts = {};
            data.forEach(n => { counts[n.s] = (counts[n.s] || 0) + 1; });
            const sortedKeys = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            const values = sortedKeys.map(k => counts[k]);
            const bgColors = sortedKeys.map(k => {
                let item = data.find(n => n.s === k);
                return getColor(item ? item.l : 'Other', k);
            });

            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labelColor = isDarkMode ? '#e0e0e0' : '#2c3e50';

            chartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: sortedKeys,
                    datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 1 }]
                },
                options: {
                    responsive: true,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) filterMap(sortedKeys[elements[0].index]);
                    },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: labelColor, display: chartType === 'bar' } },
                        y: { ticks: { color: labelColor, display: chartType === 'bar' } }
                    }
                }
            });
            
            const container = document.getElementById('legends');
            container.innerHTML = '<div class="legend-title">Top Suffixes</div>';
            sortedKeys.slice(0, 5).forEach(k => {
                let sample = data.find(n => n.s === k);
                let color = getColor(sample ? sample.l : 'Other', k);
                container.innerHTML += `<div class="legend-item" onclick="filterMap('${k}')"><span class="dot" style="background:${color}"></span><b>${k}</b>: ${counts[k]}</div>`;
            });
        }

        function filterMap(selectedSuffix) {
            markers.forEach(layer => {
                if (layer.suffix === selectedSuffix) {
                    layer.setStyle({ fillOpacity: 1, opacity: 1, radius: 8, stroke: true });
                    layer.bringToFront();
                } else {
                    layer.setStyle({ fillOpacity: 0.1, opacity: 0.1, radius: 4, stroke: false });
                }
            });
        }

        function resetFilter() {
            if(!currentCityData) return;
            renderMap(currentCityData.neighborhoods);
            renderChart(currentCityData.neighborhoods);
        }

        function switchChart(type) {
            chartType = type;
            document.querySelectorAll('.btn-chart').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderChart(currentCityData.neighborhoods);
        }

        function downloadCSV() {
            if (!currentCityData) return;
            let csv = "Name,Suffix,Meaning,Language,Lat,Lon\n";
            currentCityData.neighborhoods.forEach(n => {
                let safeSuffix = n.s.startsWith('-') ? n.s.substring(1) : n.s;
                csv += `"${n.n}","${safeSuffix}","${n.m}","${n.l}",${n.lat},${n.lon}\n`;
            });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = `${currentCityData.name}_Etymology.csv`;
            link.click();
        }

        function openTab(t) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + t).style.display = 'block';
            event.target.classList.add('active');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            if (isDarkMode) {
                map.removeLayer(lightLayer);
                map.addLayer(darkLayer);
            } else {
                map.removeLayer(darkLayer);
                map.addLayer(lightLayer);
            }
            if (currentCityData) renderChart(currentCityData.neighborhoods);
        }
    </script>
</body>
</html>
